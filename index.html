<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f2f2f7" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1c1c1e" />
    <meta name="apple-itunes-app" content="app-id=6502414968" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Renfo" />
    <title>Renfo Map</title>

    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <style>
      :root {
        --ios-browser-chrome: #f2f2f7;
        --browser-bottom-inset: 0px;
        --panel-bg: rgba(255, 255, 255, 0.88);
        --panel-border: rgba(0, 0, 0, 0.08);
        --shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
        --text: rgba(0,0,0,0.92);
        --subtext: rgba(0,0,0,0.60);
        --row-sep: rgba(0,0,0,0.06);
        --row-hover: rgba(0,0,0,0.04);
        --control-bg: rgba(255,255,255,0.85);
        --list-card-bg: rgba(255,255,255,0.42);
        --list-card-border: rgba(0,0,0,0.10);
        --list-header: rgba(0,0,0,0.60);
        --detail-action-bg: rgba(255,255,255,0.42);
        --detail-action-bg-hover: rgba(255,255,255,0.56);
        --detail-card-bg: rgba(255,255,255,0.42);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --ios-browser-chrome: #1c1c1e;
          --panel-bg: rgba(30, 30, 30, 0.78);
          --panel-border: rgba(255, 255, 255, 0.10);
          --shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
          --text: rgba(255,255,255,0.92);
          --subtext: rgba(255,255,255,0.60);
          --row-sep: rgba(255,255,255,0.08);
          --row-hover: rgba(255,255,255,0.06);
          --control-bg: rgba(40,40,40,0.85);
          --list-card-bg: rgba(255,255,255,0.10);
          --list-card-border: rgba(255,255,255,0.14);
          --list-header: rgba(255,255,255,0.74);
          --detail-action-bg: rgba(255,255,255,0.10);
          --detail-action-bg-hover: rgba(255,255,255,0.16);
          --detail-card-bg: rgba(255,255,255,0.10);
        }
      }

      html {
        height: 100%;
        height: -webkit-fill-available;
      }

      body {
        margin: 0;
        min-height: 100%;
        min-height: 100dvh;
        min-height: -webkit-fill-available;
        overflow: hidden;
        background: var(--ios-browser-chrome);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      }

      #map {
        position: fixed;
        inset: 0;
        width: 100%;
        height: auto;
      }

      /* Sidebar */
      #sidebar {
        position: absolute;
        top: 16px;
        left: 16px;
        z-index: 20;
        width: 360px;
        max-height: calc(100dvh - 32px);
        display: flex;
        flex-direction: column;

        background: var(--panel-bg);
        border: 0;
        border-radius: 28px;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: var(--shadow);
        overflow: hidden;

        transform: translateX(0);
        transition: transform 220ms ease;
      }

      #sidebar.is-collapsed {
        transform: translateX(calc(-100% - 64px));
        box-shadow: none;
      }

      #sidebarHeader {
        position: relative;
        padding: 14px 14px 10px 14px;
        border-bottom: 0;
      }

      #sidebarGrabber {
        display: none;
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 62px;
        height: 5px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--subtext) 55%, transparent);
        touch-action: none;
      }

      #brandRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      #brandLeft {
        display: flex;
        align-items: center;
        gap: 2px;
        min-width: 0;
      }

      #brandTitle {
        min-width: 0;
        margin-left: -2px;
      }

      #brandRow h1 {
        margin: 0;
        font-size: 19px;
        font-weight: 680;
        letter-spacing: -0.15px;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #headerActions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .icon {
        width: 24px;
        height: 24px;
        flex: 0 0 auto;
        display: inline-block;
      }

      .icon svg { width: 100%; height: 100%; display: block; }

      #brandLogo {
        width: 22px;
        height: 22px;
        flex: 0 0 auto;
        display: block;
        object-fit: contain;
        filter: drop-shadow(0 2px 6px rgba(0,0,0,0.12));
      }

      .iconButton {
        border: 0;
        background: var(--detail-card-bg);
        color: var(--text);
        border-radius: 999px;
        padding: 0;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0;
        transition: box-shadow 150ms ease, transform 120ms ease;
      }

      .iconButton:hover,
      .iconButton:focus-visible {
        box-shadow: inset 0 0 0 999px var(--row-hover);
      }
      .iconButton:active { transform: translateY(0.5px); }

      #optionsBtn {
        width: 44px;
        height: 44px;
      }

      #optionsBtn.is-menu-open {
        opacity: 0;
        transform: scale(0.84);
        pointer-events: none;
      }

      #collapseBtn,
      #detailCloseBtn {
        width: 44px;
        height: 44px;
      }

      #optionsMenu {
        position: absolute;
        top: 56px;
        right: 14px;
        z-index: 40;
        width: min(212px, calc(100% - 28px));
        padding: 8px 8px 10px 8px;
        border-radius: 24px;
        border: 0;
        background: color-mix(in srgb, var(--panel-bg) 82%, rgba(10,10,14,0.56));
        color: var(--text);
        box-shadow: 0 16px 34px rgba(0,0,0,0.32);
        backdrop-filter: blur(20px) saturate(120%);
        -webkit-backdrop-filter: blur(20px) saturate(120%);
        transform-origin: top right;
      }

      #optionsMenu[hidden] {
        display: none !important;
      }

      .optionsRow {
        width: 100%;
        border: 0;
        background: transparent;
        color: inherit;
        border-radius: 14px;
        padding: 10px 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        text-align: left;
        cursor: pointer;
      }

      .optionsRow:hover {
        background: var(--row-hover);
      }

      .optionsIcon {
        width: 24px;
        height: 24px;
        flex: 0 0 auto;
        opacity: 0.9;
      }

      .optionsIcon svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .optionsText {
        min-width: 0;
        flex: 1;
      }

      .optionsTitle {
        margin: 0;
        font-size: 14px;
        font-weight: 650;
        line-height: 1.1;
      }

      .optionsValue {
        margin: 3px 0 0 0;
        font-size: 12px;
        color: var(--subtext);
        opacity: 1;
        line-height: 1.1;
      }

      .optionsChevron {
        width: 18px;
        height: 18px;
        flex: 0 0 auto;
        opacity: 0.74;
        transition: transform 160ms ease;
      }

      .optionsChevron svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .optionsRow.is-open .optionsChevron {
        transform: rotate(90deg);
      }

      #optionsMenu.options-menu-down {
        animation: optionsMenuInDown 170ms ease;
      }

      #optionsMenu.options-menu-up {
        animation: optionsMenuInUp 170ms ease;
      }

      @keyframes optionsMenuInDown {
        from {
          opacity: 0;
          transform: translateY(-6px) scale(0.94);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes optionsMenuInUp {
        from {
          opacity: 0;
          transform: translateY(calc(-100% + 6px)) scale(0.94);
        }
        to {
          opacity: 1;
          transform: translateY(-100%) scale(1);
        }
      }

      .optionsChoices {
        display: block;
        padding: 2px 0 8px 0;
      }

      .optionsChoices::before {
        content: "";
        display: block;
        height: 1px;
        margin: 2px 12px 6px 12px;
        background: var(--row-sep);
      }

      .optionsChoices[hidden] {
        display: none !important;
      }

      .optionChoice {
        width: 100%;
        border: 0;
        background: transparent;
        color: var(--text);
        border-radius: 10px;
        font-size: 16px;
        font-weight: 500;
        line-height: 1.2;
        text-align: left;
        padding: 10px 12px 10px 36px;
        position: relative;
        cursor: pointer;
      }

      .optionChoice::before {
        content: "";
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        text-align: center;
        font-size: 17px;
        line-height: 1;
      }

      .optionChoice:hover {
        background: var(--row-hover);
      }

      .optionChoice.is-active {
        background: color-mix(in srgb, var(--row-hover) 82%, transparent);
      }

      .optionChoice.is-active::before {
        content: "\2713";
      }

      #searchWrap {
        margin-top: 10px;
        position: relative;
      }

      #searchIcon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        opacity: 0.6;
        pointer-events: none;
      }

      #searchIcon svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      #search {
        width: 100%;
        box-sizing: border-box;
        border: 0;
        border-radius: 999px;
        padding: 12px 36px 12px 36px;
        font-size: 14px;
        outline: none;
        background: var(--detail-card-bg);
        color: var(--text);
      }

      #search::-webkit-search-cancel-button {
        -webkit-appearance: none;
        appearance: none;
      }

      #searchClearBtn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        border: 0;
        border-radius: 999px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: color-mix(in srgb, var(--subtext) 72%, transparent);
        color: rgba(255,255,255,0.96);
        cursor: pointer;
      }

      #searchClearBtn[hidden] {
        display: none !important;
      }

      #searchClearBtn:hover,
      #searchClearBtn:focus-visible {
        filter: brightness(1.08);
      }

      #searchClearBtn svg {
        width: 12px;
        height: 12px;
        display: block;
      }

      #controlsRow {
        display: none;
      }

      .selectWrap {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .label {
        font-size: 11px;
        opacity: 0.75;
        color: var(--subtext);
      }

      select {
        width: 100%;
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        padding: 10px 10px;
        background: var(--control-bg);
        color: var(--text);
        font-size: 13px;
        outline: none;
        appearance: none;
      }

      #list {
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        padding: 6px 12px 12px 12px;
        isolation: isolate;
      }

      .sectionHeader {
        position: static;
        margin: 0 2px;
        padding: 10px 10px 8px 10px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        color: var(--list-header);
        background: transparent;
      }

      .sectionHeader.sectionHeaderSpacer {
        padding: 6px 10px 4px 10px;
        color: transparent;
        user-select: none;
        pointer-events: none;
      }

      .sectionGroup {
        border: 0;
        border-radius: 24px;
        background: var(--detail-card-bg);
        overflow: hidden;
        margin-bottom: 12px;
      }

      .row {
        padding: 12px 14px;
        border: 0;
        border-radius: 0;
        background: transparent;
        margin: 0;
        cursor: pointer;
        transition: background 140ms ease;
      }

      .row + .row {
        border-top: 1px solid var(--row-sep);
      }

      .row:hover { background: var(--row-hover); }
      .row.is-selected {
        background: color-mix(in srgb, var(--row-hover) 55%, transparent);
      }

      .rowMain {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }

      .rowLogo {
        width: 24px;
        height: 24px;
        border-radius: 999px;
        flex: 0 0 auto;
        object-fit: cover;
      }

      #detailSidebar {
        position: absolute;
        top: 16px;
        left: 388px;
        z-index: 19;
        width: 348px;
        max-height: calc(100dvh - 32px);
        display: flex;
        flex-direction: column;
        background: var(--panel-bg);
        border: 0;
        border-radius: 28px;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      #detailSidebar[hidden] {
        display: none !important;
      }

      body.list-collapsed #detailSidebar {
        left: 72px;
        border-left: 0;
        border-radius: 28px;
      }

      #detailHeader {
        display: flex;
        justify-content: flex-end;
        padding: 10px 12px 0 12px;
        flex: 0 0 auto;
      }

      #detailBody {
        flex: 1 1 auto;
        min-height: 0;
        padding: 8px 14px 14px 14px;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      #detailBody > * {
        flex: 0 0 auto;
      }

      #detailHero {
        text-align: center;
      }

      #detailHeroLogoWrap {
        width: 154px;
        height: 154px;
        margin: 0 auto;
        border-radius: 999px;
        overflow: hidden;
      }

      #detailHeroLogo {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: cover;
      }

      #detailStatus {
        margin: 10px auto 0 auto;
        font-size: 11px;
        line-height: 1;
        display: inline-block;
        padding: 5px 9px;
        border-radius: 999px;
        border: 0;
        background: var(--control-bg);
        color: var(--subtext);
      }

      #detailTitle {
        margin: 10px 0 0 0;
        font-size: 24px;
        line-height: 1.15;
        font-weight: 700;
      }

      #detailActions {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
      }

      .detailAction {
        border: 0;
        background: var(--detail-action-bg);
        border-radius: 16px;
        padding: 5px 8px;
        text-decoration: none;
        color: var(--text);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 3px;
        min-height: 48px;
        backdrop-filter: blur(7px);
        -webkit-backdrop-filter: blur(7px);
      }

      .detailAction:hover {
        box-shadow: inset 0 0 0 999px var(--row-hover);
      }

      .detailAction.is-disabled {
        opacity: 0.4;
        pointer-events: none;
      }

      .detailActionIcon {
        width: 21px;
        height: 21px;
        display: block;
      }

      .detailActionIcon svg {
        width: 100%;
        height: 100%;
        display: block;
        fill: none;
        stroke: currentColor;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      #detailActionCall .detailActionIcon svg {
        fill: currentColor;
      }

      #detailActionDirections .detailActionIcon svg {
        fill: currentColor;
      }

      #detailActionWebsite .detailActionIcon svg {
        fill: none;
        stroke: none;
      }

      #detailActionWebsite .detailActionIcon svg circle {
        fill: currentColor;
      }

      #detailActionWebsite .detailActionIcon svg path {
        fill: var(--ios-browser-chrome);
      }

      .detailActionLabel {
        font-size: 12px;
        font-weight: 650;
        line-height: 1;
      }

      .detailCard {
        border: 0;
        border-radius: 20px;
        background: var(--detail-card-bg);
        overflow: hidden;
      }

      #detailSocialCard {
        padding: 2px 0 0 0;
      }

      #detailSocials {
        display: flex;
        flex-wrap: nowrap;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }

      .detailSocialBtn {
        width: 42px;
        height: 42px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        color: var(--text);
        border: 0;
        background: transparent;
        border-radius: 999px;
        padding: 0;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        transition: background 150ms ease, transform 120ms ease;
      }

      .detailSocialBtn:hover,
      .detailSocialBtn:focus-visible {
        box-shadow: inset 0 0 0 999px var(--row-hover);
      }

      .detailSocialBtn:active {
        transform: translateY(0.5px);
      }

      .detailSocialIcon {
        width: 24px;
        height: 24px;
        display: block;
      }

      .detailSocialIcon svg {
        width: 100%;
        height: 100%;
        display: block;
        fill: none;
        stroke: currentColor;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      #detailEstablishedRow {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin: 0 auto;
        color: var(--subtext);
        font-size: 18px;
        font-weight: 650;
        letter-spacing: 0.1px;
        line-height: 1;
      }

      #detailEstablishedRow[hidden] {
        display: none !important;
      }

      .detailEstablishedDash {
        width: 56px;
        height: 2px;
        border-radius: 999px;
        display: inline-block;
        background: color-mix(in srgb, var(--subtext) 88%, var(--text) 12%);
      }

      .detailInfoRow {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
      }

      .detailInfoRow[hidden] {
        display: none !important;
      }

      .detailInfoRow + .detailInfoRow {
        border-top: 1px solid var(--row-sep);
      }

      .detailInfoKey {
        width: 20px;
        height: 20px;
        flex: 0 0 auto;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--text);
      }

      .detailInfoKey svg {
        width: 100%;
        height: 100%;
        display: block;
        fill: none;
        stroke: currentColor;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .detailInfoValue {
        font-size: 15px;
        font-weight: 400;
      }

      #detailAddressCard,
      #detailResourcesCard,
      #detailDescriptionCard {
        display: flex;
        flex-direction: column;
      }

      #detailResourcesCard[hidden],
      #detailDescriptionCard[hidden] {
        display: none !important;
      }

      .detailSectionHeader {
        padding: 10px 10px 8px 10px;
      }

      .detailAddressPanel {
        padding: 10px 12px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .detailAddressText {
        min-width: 0;
        flex: 1;
      }

      .detailAddressBtn {
        width: 40px;
        height: 40px;
        flex: 0 0 auto;
        align-self: center;
        text-decoration: none;
      }

      .detailAddressBtn .icon {
        width: 20px;
        height: 20px;
      }

      .detailAddressBtn.is-disabled {
        opacity: 0.4;
        pointer-events: none;
      }

      .detailDescriptionPanel {
        padding: 10px 12px;
      }

      .detailAddressLine {
        margin: 0;
        font-size: 16px;
        line-height: 1.25;
      }

      .detailAddressLine + .detailAddressLine {
        margin-top: 6px;
      }

      .detailResourcesPanel {
        padding: 0;
      }

      #detailResources {
        border: 0;
        border-radius: 0;
        overflow: hidden;
        background: transparent;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }

      .detailResourceBtn {
        text-decoration: none;
        color: var(--text);
        padding: 10px 12px;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        font-weight: 400;
      }

      .detailResourceBtn + .detailResourceBtn {
        border-top: 1px solid var(--row-sep);
      }

      .detailResourceBtn:hover {
        background: var(--row-hover);
      }

      .detailResourceIcon {
        width: 18px;
        height: 18px;
        display: block;
        flex: 0 0 auto;
      }

      .detailResourceIcon svg {
        width: 100%;
        height: 100%;
        display: block;
        fill: none;
        stroke: currentColor;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .detailResourceLabel {
        min-width: 0;
        flex: 1;
      }

      .detailResourceChevron {
        width: 14px;
        height: 14px;
        display: block;
        flex: 0 0 auto;
        opacity: 0.66;
      }

      .detailResourceChevron svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      #detailDesc {
        margin: 0;
        font-size: 12px;
        line-height: 1.4;
        color: var(--text);
      }

      .rowTitle {
        font-size: 15px;
        font-weight: 400;
        margin: 0;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Expand button (shown when sidebar is collapsed) */
      #expandPill {
        position: absolute;
        top: 16px;
        left: 16px;
        z-index: 21;
        display: none;
        border: 0;
        background: var(--detail-card-bg);
        color: var(--text);
        border-radius: 999px;
        width: 44px;
        height: 44px;
        padding: 0;
        box-shadow: var(--shadow);
        cursor: pointer;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        align-items: center;
        justify-content: center;
        transition: box-shadow 150ms ease, transform 120ms ease;
      }

      #expandPill:hover,
      #expandPill:focus-visible {
        box-shadow: var(--shadow), inset 0 0 0 999px var(--row-hover);
      }

      #expandPill.show { display: inline-flex; }

      /* Mobile: sidebar becomes top sheet */
      @media (max-width: 640px) {
        #expandPill,
        #collapseBtn {
          display: none !important;
        }

        #sidebar {
          left: 0;
          right: 0;
          bottom: 0;
          top: auto;
          width: auto;
          max-height: min(92svh, calc(100svh - 8px));
          border-radius: 34px 34px 0 0;
          border-left: 0;
          transform: translateY(var(--mobile-list-offset, 0px));
          transition: transform 220ms ease, opacity 180ms ease;
          opacity: 1;
        }

        body.mobile-mode::after {
          content: "";
          position: fixed;
          left: 0;
          right: 0;
          bottom: 0;
          height: max(env(safe-area-inset-bottom, 0px), var(--browser-bottom-inset, 0px));
          background: var(--ios-browser-chrome);
          z-index: 25;
          pointer-events: none;
        }

        #sidebar.is-collapsed {
          transform: translateY(var(--mobile-list-offset, 0px));
        }

        #sidebarHeader {
          padding-top: 14px;
        }

        #brandLeft {
          gap: 2px;
        }

        #brandLogo {
          width: 21px;
          height: 21px;
        }

        #brandRow h1 {
          font-size: 21px;
          font-weight: 640;
          letter-spacing: -0.1px;
          line-height: 1.02;
        }

        #brandTitle {
          margin-left: -2px;
        }

        #optionsMenu {
          width: min(212px, calc(100% - 20px));
          padding: 6px;
          border-radius: 22px;
          transform: translateY(0);
          transform-origin: top right;
        }

        #optionsMenu.options-menu-up {
          transform: translateY(-100%);
          transform-origin: bottom right;
        }

        #search {
          font-size: 16px;
        }

        .optionsRow {
          padding: 10px 8px;
          gap: 10px;
          border-radius: 12px;
        }

        .optionsIcon {
          width: 24px;
          height: 24px;
        }

        .optionsTitle {
          font-size: 14px;
        }

        .optionsValue {
          margin-top: 2px;
          font-size: 12px;
        }

        .optionsChoices {
          padding: 2px 0 8px 0;
        }

        .optionChoice {
          font-size: 15px;
          padding: 10px 10px 10px 34px;
        }

        #sidebarGrabber {
          display: block;
        }

        #list {
          padding-bottom: calc(12px + max(env(safe-area-inset-bottom, 0px), var(--browser-bottom-inset, 0px)));
        }

        #detailSidebar {
          left: 0;
          right: 0;
          width: auto;
          top: auto;
          bottom: max(env(safe-area-inset-bottom, 0px), var(--browser-bottom-inset, 0px));
          height: min(92svh, calc(100svh - max(env(safe-area-inset-bottom, 0px), var(--browser-bottom-inset, 0px)) - 8px));
          max-height: min(92svh, calc(100svh - max(env(safe-area-inset-bottom, 0px), var(--browser-bottom-inset, 0px)) - 8px));
          border-left: 0;
          border-radius: 34px 34px 0 0;
          z-index: 30;
          padding-bottom: 0;
        }

        #sidebar.options-open {
          overflow: visible;
        }

        body.mobile-mode.mobile-detail-open #sidebar {
          transform: translateY(calc(100% + max(env(safe-area-inset-bottom, 0px), var(--browser-bottom-inset, 0px)) + 72px)) !important;
          opacity: 0;
          pointer-events: none;
        }

        .row {
          padding: 14px 16px;
        }

        .rowMain {
          gap: 14px;
        }

        .rowLogo {
          width: 34px;
          height: 34px;
        }

        .rowTitle {
          font-size: 18px;
          line-height: 1.18;
        }
      }
    </style>

    <!-- MapKit JS -->
    <script src="/config.js"></script>
    <script>
      window.__mapKitReady = false;
      window.initMapKit = function initMapKit() {
        window.__mapKitReady = true;
      };
    </script>
    <script
      src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.core.js"
      crossorigin
      defer
      data-callback="initMapKit"
      data-libraries="map,annotations,user-location"
      data-token=""
    ></script>
    <script>
      // Inject token at runtime
      document.currentScript.previousElementSibling.setAttribute(
        "data-token",
        window.RENFO_CONFIG.MAPKIT_TOKEN
      );
    </script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer></script>
  </head>

  <body>
    <button id="expandPill" type="button" aria-label="Expand sidebar">
      <span class="icon" aria-hidden="true">
        <i data-lucide="panel-left-open"></i>
      </span>
    </button>

    <div id="sidebar">
      <div id="sidebarHeader">
        <div id="sidebarGrabber" aria-hidden="true"></div>
        <div id="brandRow">
          <div id="brandLeft">
            <img id="brandLogo" src="/renfo-logo.png" alt="" aria-hidden="true" />

            <div id="brandTitle">
              <h1>Renfo</h1>
            </div>
          </div>

          <div id="headerActions">
            <button id="optionsBtn" type="button" class="iconButton" aria-label="Display grouping and sorting options" title="Options">
              <span class="icon" aria-hidden="true">
                <i data-lucide="more-horizontal"></i>
              </span>
            </button>

            <button id="collapseBtn" class="iconButton" aria-label="Collapse sidebar" title="Collapse">
              <span class="icon" aria-hidden="true">
                <i data-lucide="panel-left-close"></i>
              </span>
            </button>
          </div>
        </div>

        <div id="optionsMenu" hidden>
          <button id="groupMenuRow" class="optionsRow" type="button" aria-label="Group by setting" aria-expanded="false">
            <span class="optionsIcon" aria-hidden="true">
              <i data-lucide="layout-list"></i>
            </span>
            <span class="optionsText">
              <p class="optionsTitle">Group By</p>
              <p id="groupSummary" class="optionsValue">None</p>
            </span>
            <span class="optionsChevron" aria-hidden="true">
              <i data-lucide="chevron-right"></i>
            </span>
          </button>
          <div id="groupChoices" class="optionsChoices" hidden>
            <button type="button" class="optionChoice" data-select="group" data-value="none">None</button>
            <button type="button" class="optionChoice" data-select="group" data-value="state">State</button>
            <button type="button" class="optionChoice" data-select="group" data-value="status">Status</button>
          </div>

          <button id="sortMenuRow" class="optionsRow" type="button" aria-label="Sort by setting" aria-expanded="false">
            <span class="optionsIcon" aria-hidden="true">
              <i data-lucide="arrow-up-down"></i>
            </span>
            <span class="optionsText">
              <p class="optionsTitle">Sort By</p>
              <p id="sortSummary" class="optionsValue">Name</p>
            </span>
            <span class="optionsChevron" aria-hidden="true">
              <i data-lucide="chevron-right"></i>
            </span>
          </button>
          <div id="sortChoices" class="optionsChoices" hidden>
            <button type="button" class="optionChoice" data-select="sort" data-value="name">Name</button>
            <button type="button" class="optionChoice" data-select="sort" data-value="startDate">Start Date</button>
          </div>
        </div>

        <div id="searchWrap">
          <span id="searchIcon" aria-hidden="true">
            <i data-lucide="search"></i>
          </span>
          <input id="search" type="search" placeholder="Search" autocomplete="off" />
          <button id="searchClearBtn" type="button" aria-label="Clear search" title="Clear search" hidden>
            <i data-lucide="x" aria-hidden="true"></i>
          </button>
        </div>

        <div id="controlsRow" hidden>
          <div class="selectWrap">
            <div class="label">Group</div>
            <select id="groupSelect">
              <option value="none" selected>None</option>
              <option value="state">State</option>
              <option value="status">Status</option>
            </select>
          </div>

          <div class="selectWrap">
            <div class="label">Sort</div>
            <select id="sortSelect">
              <option value="name" selected>Name</option>
              <option value="startDate">Start Date</option>
            </select>
          </div>
        </div>

      </div>

      <div id="list"></div>
    </div>

    <div id="detailSidebar" hidden>
      <div id="detailHeader">
        <button id="detailCloseBtn" type="button" class="iconButton" aria-label="Close festival details" title="Close details">
          <span class="icon" aria-hidden="true">
            <i data-lucide="x"></i>
          </span>
        </button>
      </div>
      <div id="detailBody">
        <section id="detailHero">
          <div id="detailHeroLogoWrap">
            <img id="detailHeroLogo" src="/renfo-logo.png" alt="" aria-hidden="true" />
          </div>
          <p id="detailStatus" hidden></p>
          <p id="detailTitle"></p>
        </section>

        <section id="detailActions">
          <a id="detailActionDirections" class="detailAction" href="#" aria-label="Get directions">
            <span class="detailActionIcon" aria-hidden="true">
              <i data-lucide="navigation"></i>
            </span>
            <span class="detailActionLabel">Directions</span>
          </a>
          <a id="detailActionCall" class="detailAction" href="#" aria-label="Call festival">
            <span class="detailActionIcon" aria-hidden="true">
              <i data-lucide="phone"></i>
            </span>
            <span class="detailActionLabel">Call</span>
          </a>
          <a id="detailActionWebsite" class="detailAction" href="#" aria-label="Open website">
            <span class="detailActionIcon" aria-hidden="true">
              <i data-lucide="compass"></i>
            </span>
            <span class="detailActionLabel">Website</span>
          </a>
        </section>

        <section id="detailInfoCard" class="detailCard">
          <div class="detailInfoRow">
            <span class="detailInfoKey" aria-hidden="true" title="Dates">
              <i data-lucide="calendar-days"></i>
            </span>
            <span id="detailDateValue" class="detailInfoValue"></span>
          </div>
          <div class="detailInfoRow">
            <span class="detailInfoKey" aria-hidden="true" title="Hours">
              <i data-lucide="clock-3"></i>
            </span>
            <span id="detailTimeValue" class="detailInfoValue"></span>
          </div>
          <div id="detailAttendanceRow" class="detailInfoRow">
            <span class="detailInfoKey" aria-hidden="true" title="Attendance">
              <i data-lucide="users"></i>
            </span>
            <span id="detailAttendanceValue" class="detailInfoValue"></span>
          </div>
        </section>

        <div id="detailAddressCard">
          <section class="detailCard detailAddressPanel">
            <div class="detailAddressText">
              <p id="detailAddressLine1" class="detailAddressLine"></p>
              <p id="detailAddressLine2" class="detailAddressLine"></p>
              <p id="detailAddressLine3" class="detailAddressLine"></p>
            </div>
            <a id="detailAddressOpenBtn" class="iconButton detailAddressBtn" href="#" aria-label="Open address in maps" title="Open in maps">
              <span class="icon" aria-hidden="true">
                <i data-lucide="corner-up-right"></i>
              </span>
            </a>
          </section>
        </div>

        <div id="detailResourcesCard" hidden>
          <p class="sectionHeader detailSectionHeader">Resources</p>
          <section class="detailCard detailResourcesPanel">
            <div id="detailResources"></div>
          </section>
        </div>

        <div id="detailDescriptionCard">
          <p class="sectionHeader detailSectionHeader">About</p>
          <section class="detailCard detailDescriptionPanel">
            <p id="detailDesc"></p>
          </section>
        </div>

        <section id="detailSocialCard" hidden>
          <div id="detailSocials"></div>
        </section>

        <section id="detailEstablishedRow" hidden>
          <span class="detailEstablishedDash" aria-hidden="true"></span>
          <span id="detailEstablishedValue"></span>
          <span class="detailEstablishedDash" aria-hidden="true"></span>
        </section>
      </div>
    </div>

    <div id="map"></div>

    <script type="module">
      // ---------- Helpers ----------
      function isMapLibraryLoaded() {
        const libs = window.mapkit?.loadedLibraries;
        if (!libs) return false;
        if (Array.isArray(libs)) return libs.includes("map");
        if (typeof libs.has === "function") return libs.has("map");
        return Boolean(libs.map || libs["map"]);
      }

      async function waitForMapKit() {
        if (!window.__mapKitReady) {
          await new Promise(resolve => {
            const previousInit = window.initMapKit;
            window.initMapKit = () => {
              try {
                previousInit?.();
              } catch (_) {}
              resolve();
            };
          });
        }

        if (isMapLibraryLoaded()) return;

        await new Promise((resolve, reject) => {
          const timeoutMs = 8000;
          const startMs = Date.now();
          const timer = setInterval(() => {
            if (isMapLibraryLoaded()) {
              clearInterval(timer);
              resolve();
              return;
            }

            if (Date.now() - startMs >= timeoutMs) {
              clearInterval(timer);
              reject(new Error("MapKit map library did not load."));
            }
          }, 50);
        });
      }

      function getMapFeatureVisibility(visibilityName) {
        return window.mapkit?.FeatureVisibility?.[visibilityName];
      }

      function getMapPadding(top, right, bottom, left) {
        if (typeof window.mapkit?.Padding === "function") {
          return new window.mapkit.Padding(top, right, bottom, left);
        }
        return { top, right, bottom, left };
      }

      async function loadFestivals() {
        const response = await fetch("./festivals.json", { cache: "no-store" });
        const data = await response.json();

        return (data ?? [])
          .filter(f => f.latitude != null && f.longitude != null)
          .map(f => ({
            ...f,
            lat: f.latitude,
            lng: f.longitude,
            subtitle: `${f.city ?? ""}${f.city && f.state ? ", " : ""}${f.state ?? ""}`.trim(),
            logoAssetUrl: getFestivalAssetUrl(f, "logo"),
            mapAssetUrl: getFestivalAssetUrl(f, "map"),
            campAssetUrl: getFestivalAssetUrl(f, "camp")
          }));
      }

      const DEFAULT_FESTIVAL_LOGO = "/renfo-logo.png";
      const ASSETS_BASE_URL = String(window.RENFO_CONFIG?.ASSETS_BASE_URL || "https://assets.renfo.app").replace(/\/+$/, "");

      function sanitizeAssetPart(value) {
        return String(value ?? "")
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9]/g, "");
      }

      function getFestivalAssetUrl(f, type) {
        const state = sanitizeAssetPart(f.state);
        const abbreviation = sanitizeAssetPart(f.abbreviation);
        const assetType = sanitizeAssetPart(type);
        if (!state || !abbreviation || !assetType) return null;
        return `${ASSETS_BASE_URL}/${state}-${abbreviation}-${assetType}.png`;
      }

      function setImageWithFallback(img, primarySrc, fallbackSrc = DEFAULT_FESTIVAL_LOGO) {
        img.onerror = () => {
          img.onerror = null;
          img.src = fallbackSrc;
        };
        img.src = primarySrc || fallbackSrc;
      }

      function normalize(s) {
        return (s ?? "").toString().toLowerCase();
      }

      function parseDate(value) {
        if (!value) return null;
        const d = new Date(value);
        return Number.isFinite(d.getTime()) ? d : null;
      }

      function compareByName(a, b) {
        return (a.name || "").localeCompare(b.name || "", undefined, { sensitivity: "base" });
      }

      function compareByStartDate(a, b) {
        const da = parseDate(a.dateBegin) ?? parseDate(a.startDate) ?? null;
        const db = parseDate(b.dateBegin) ?? parseDate(b.startDate) ?? null;

        // Nulls last
        if (da && db) return da - db || compareByName(a, b);
        if (da && !db) return -1;
        if (!da && db) return 1;
        return compareByName(a, b);
      }

      function getGroupKey(f, groupMode) {
        if (groupMode === "state") return f.stateName || f.state || "Unknown";
        if (groupMode === "status") return f.status || "Unknown";
        return "All";
      }

      function sortFestivals(items, sortMode) {
        const copy = [...items];
        copy.sort(sortMode === "startDate" ? compareByStartDate : compareByName);
        return copy;
      }

      // ---------- UI elements ----------
      const $search = document.getElementById("search");
      const $searchClearBtn = document.getElementById("searchClearBtn");
      const $list = document.getElementById("list");
      const $group = document.getElementById("groupSelect");
      const $sort = document.getElementById("sortSelect");
      const $sidebar = document.getElementById("sidebar");
      const $sidebarHeader = document.getElementById("sidebarHeader");
      const $sidebarGrabber = document.getElementById("sidebarGrabber");
      const $collapseBtn = document.getElementById("collapseBtn");
      const $expandPill = document.getElementById("expandPill");
      const $optionsBtn = document.getElementById("optionsBtn");
      const $optionsMenu = document.getElementById("optionsMenu");
      const $groupMenuRow = document.getElementById("groupMenuRow");
      const $sortMenuRow = document.getElementById("sortMenuRow");
      const $groupChoices = document.getElementById("groupChoices");
      const $sortChoices = document.getElementById("sortChoices");
      const $groupSummary = document.getElementById("groupSummary");
      const $sortSummary = document.getElementById("sortSummary");
      const $groupChoiceButtons = Array.from(document.querySelectorAll('.optionChoice[data-select="group"]'));
      const $sortChoiceButtons = Array.from(document.querySelectorAll('.optionChoice[data-select="sort"]'));
      const $detailSidebar = document.getElementById("detailSidebar");
      const $detailCloseBtn = document.getElementById("detailCloseBtn");
      const $detailHeroLogo = document.getElementById("detailHeroLogo");
      const $detailTitle = document.getElementById("detailTitle");
      const $detailStatus = document.getElementById("detailStatus");
      const $detailSocialCard = document.getElementById("detailSocialCard");
      const $detailSocials = document.getElementById("detailSocials");
      const $detailDescriptionCard = document.getElementById("detailDescriptionCard");
      const $detailDesc = document.getElementById("detailDesc");
      const $detailActionCall = document.getElementById("detailActionCall");
      const $detailActionDirections = document.getElementById("detailActionDirections");
      const $detailActionWebsite = document.getElementById("detailActionWebsite");
      const $detailDateValue = document.getElementById("detailDateValue");
      const $detailTimeValue = document.getElementById("detailTimeValue");
      const $detailAttendanceRow = document.getElementById("detailAttendanceRow");
      const $detailAttendanceValue = document.getElementById("detailAttendanceValue");
      const $detailAddressLine1 = document.getElementById("detailAddressLine1");
      const $detailAddressLine2 = document.getElementById("detailAddressLine2");
      const $detailAddressLine3 = document.getElementById("detailAddressLine3");
      const $detailAddressOpenBtn = document.getElementById("detailAddressOpenBtn");
      const $detailResourcesCard = document.getElementById("detailResourcesCard");
      const $detailResources = document.getElementById("detailResources");
      const $detailEstablishedRow = document.getElementById("detailEstablishedRow");
      const $detailEstablishedValue = document.getElementById("detailEstablishedValue");
      let selectedFestivalId = null;
      let detailRenderVersion = 0;
      const resourceAssetExistsCache = new Map();
      const mobileMedia = window.matchMedia("(max-width: 640px)");
      let mobileSheetState = "peek";
      let mobileSheetOffset = 0;
      let mobileSheetDrag = null;

      function syncBrowserBottomInset() {
        const vv = window.visualViewport;
        let bottomInset = 0;
        if (vv) {
          const innerDelta = Math.round((window.innerHeight || 0) - vv.height);
          const clientDelta = Math.round((document.documentElement?.clientHeight || 0) - vv.height);
          const offsetDelta = Math.round((window.innerHeight || 0) - (vv.height + vv.offsetTop));
          bottomInset = Math.max(0, innerDelta, clientDelta, offsetDelta);
          // Ignore on-screen keyboard insets; this offset is for browser chrome overlap.
          if (bottomInset > 140) bottomInset = 0;
        }
        document.documentElement.style.setProperty("--browser-bottom-inset", `${bottomInset}px`);
      }

      function getSelectLabel(selectEl) {
        return selectEl.options[selectEl.selectedIndex]?.textContent ?? "";
      }

      function syncOptionsMenuState() {
        $groupSummary.textContent = getSelectLabel($group);
        $sortSummary.textContent = getSelectLabel($sort);

        for (const button of $groupChoiceButtons) {
          button.classList.toggle("is-active", button.dataset.value === $group.value);
        }
        for (const button of $sortChoiceButtons) {
          button.classList.toggle("is-active", button.dataset.value === $sort.value);
        }
      }

      function syncOptionsMenuDirection() {
        if (!isMobileViewport()) {
          $optionsMenu.classList.remove("options-menu-up");
          $optionsMenu.classList.add("options-menu-down");
          return;
        }

        const sheetTop = $sidebar.getBoundingClientRect().top;
        const openDown = sheetTop <= (window.innerHeight * 0.5);
        $optionsMenu.classList.toggle("options-menu-down", openDown);
        $optionsMenu.classList.toggle("options-menu-up", !openDown);
      }

      function positionOptionsMenu() {
        const headerRect = $sidebarHeader.getBoundingClientRect();
        const btnRect = $optionsBtn.getBoundingClientRect();
        const right = Math.max(8, Math.round(headerRect.right - btnRect.right));
        const openUp = isMobileViewport() && $optionsMenu.classList.contains("options-menu-up");
        const top = openUp
          ? Math.round(btnRect.bottom - headerRect.top)
          : Math.round(btnRect.top - headerRect.top);

        $optionsMenu.style.right = `${right}px`;
        $optionsMenu.style.top = `${top}px`;
      }

      function setChoicesOpen(type, open) {
        const isGroup = type === "group";
        const row = isGroup ? $groupMenuRow : $sortMenuRow;
        const choices = isGroup ? $groupChoices : $sortChoices;
        choices.hidden = !open;
        row.classList.toggle("is-open", open);
        row.setAttribute("aria-expanded", open ? "true" : "false");
      }

      function closeOptionsMenu() {
        $optionsMenu.hidden = true;
        $optionsBtn.classList.remove("is-menu-open");
        $sidebar.classList.remove("options-open");
        setChoicesOpen("group", false);
        setChoicesOpen("sort", false);
      }

      function toggleOptionsMenu() {
        const opening = $optionsMenu.hidden;
        if (!opening) {
          closeOptionsMenu();
          return;
        }

        syncOptionsMenuState();
        syncOptionsMenuDirection();
        positionOptionsMenu();
        $optionsMenu.hidden = false;
        $optionsBtn.classList.add("is-menu-open");
        $sidebar.classList.add("options-open");
      }

      function toggleChoices(type) {
        if (type === "group") {
          const opening = $groupChoices.hidden;
          setChoicesOpen("group", opening);
          setChoicesOpen("sort", false);
          return;
        }

        const opening = $sortChoices.hidden;
        setChoicesOpen("sort", opening);
        setChoicesOpen("group", false);
      }

      function setSelectValue(selectEl, value) {
        if (selectEl.value === value) return;
        selectEl.value = value;
        selectEl.dispatchEvent(new Event("change"));
      }

      function isMobileViewport() {
        return mobileMedia.matches;
      }

      function getMobileSheetMetrics() {
        const sidebarHeight = $sidebar.getBoundingClientRect().height;
        const headerHeight = $sidebarHeader.getBoundingClientRect().height;
        const peekVisible = Math.max(96, headerHeight - 6);
        const maxOffset = Math.max(0, sidebarHeight - peekVisible);
        return {
          full: 0,
          mid: Math.round(maxOffset * 0.44),
          peek: maxOffset
        };
      }

      function applyMobileSheetOffset(nextOffset, options = {}) {
        if (!isMobileViewport()) return;
        const { animate = true } = options;
        const { peek } = getMobileSheetMetrics();
        const clamped = Math.min(Math.max(nextOffset, 0), peek);
        mobileSheetOffset = clamped;
        if (!animate) $sidebar.style.transition = "none";
        $sidebar.style.setProperty("--mobile-list-offset", `${clamped}px`);
        if (!animate) {
          requestAnimationFrame(() => {
            $sidebar.style.removeProperty("transition");
          });
        }
      }

      function setMobileSheetState(nextState, options = {}) {
        if (!isMobileViewport()) return;
        const { animate = true } = options;
        const { full, mid, peek } = getMobileSheetMetrics();
        const target = nextState === "full" ? full : nextState === "mid" ? mid : peek;
        mobileSheetState = nextState;
        applyMobileSheetOffset(target, { animate });
      }

      function snapMobileSheetToNearest() {
        if (!isMobileViewport()) return;
        const metrics = getMobileSheetMetrics();
        const states = ["full", "mid", "peek"];
        let nearest = "peek";
        let nearestDist = Number.POSITIVE_INFINITY;
        for (const state of states) {
          const dist = Math.abs(mobileSheetOffset - metrics[state]);
          if (dist < nearestDist) {
            nearestDist = dist;
            nearest = state;
          }
        }
        setMobileSheetState(nearest, { animate: true });
      }

      function syncMobileModeClasses() {
        syncBrowserBottomInset();
        const mobile = isMobileViewport();
        document.body.classList.toggle("mobile-mode", mobile);
        if (!mobile) {
          document.body.classList.remove("mobile-detail-open");
          $sidebar.style.removeProperty("--mobile-list-offset");
          syncOptionsMenuDirection();
          positionOptionsMenu();
          return;
        }
        setMobileSheetState(mobileSheetState, { animate: false });
        if (!$optionsMenu.hidden) {
          syncOptionsMenuDirection();
          positionOptionsMenu();
        }
      }

      function syncMobileDetailSheetState(isOpen) {
        if (!isMobileViewport()) {
          document.body.classList.remove("mobile-detail-open");
          return;
        }
        if (isOpen) {
          document.body.classList.add("mobile-detail-open");
          return;
        }

        // Bring list sheet back instantly when detail closes.
        $sidebar.style.transition = "none";
        document.body.classList.remove("mobile-detail-open");
        requestAnimationFrame(() => {
          $sidebar.style.removeProperty("transition");
        });
      }

      function updateSearchClearVisibility() {
        $searchClearBtn.hidden = !$search.value;
      }

      function setCollapsed(collapsed) {
        if (isMobileViewport()) return;
        $sidebar.classList.toggle("is-collapsed", collapsed);
        $expandPill.classList.toggle("show", collapsed);
        document.body.classList.toggle("list-collapsed", collapsed);
        if (collapsed) closeOptionsMenu();
      }

      $collapseBtn.addEventListener("click", () => setCollapsed(true));
      $expandPill.addEventListener("click", () => setCollapsed(false));
      $optionsBtn.addEventListener("click", (event) => {
        event.stopPropagation();
        toggleOptionsMenu();
      });
      $optionsMenu.addEventListener("click", (event) => event.stopPropagation());
      $groupMenuRow.addEventListener("click", () => toggleChoices("group"));
      $sortMenuRow.addEventListener("click", () => toggleChoices("sort"));
      document.addEventListener("click", closeOptionsMenu);
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") closeOptionsMenu();
      });
      $searchClearBtn.addEventListener("click", () => {
        if (!$search.value) return;
        $search.value = "";
        $search.dispatchEvent(new Event("input", { bubbles: true }));
        $search.focus();
      });
      function handleMobileSheetPointerDown(event) {
        if (!isMobileViewport()) return;
        if (document.body.classList.contains("mobile-detail-open")) return;
        if (event.target.closest("button, a, input, select, textarea, label")) return;
        if (event.pointerType === "mouse" && event.button !== 0) return;

        mobileSheetDrag = {
          pointerId: event.pointerId,
          startY: event.clientY,
          startOffset: mobileSheetOffset
        };
        $sidebarHeader.setPointerCapture?.(event.pointerId);
        event.preventDefault();
      }

      function handleMobileSheetPointerMove(event) {
        if (!mobileSheetDrag) return;
        if (event.pointerId !== mobileSheetDrag.pointerId) return;
        const delta = event.clientY - mobileSheetDrag.startY;
        applyMobileSheetOffset(mobileSheetDrag.startOffset + delta, { animate: false });
        event.preventDefault();
      }

      function handleMobileSheetPointerUp(event) {
        if (!mobileSheetDrag) return;
        if (event.pointerId !== mobileSheetDrag.pointerId) return;
        mobileSheetDrag = null;
        snapMobileSheetToNearest();
      }

      $sidebarGrabber.addEventListener("pointerdown", handleMobileSheetPointerDown);
      $sidebarHeader.addEventListener("pointerdown", handleMobileSheetPointerDown);
      window.addEventListener("pointermove", handleMobileSheetPointerMove, { passive: false });
      window.addEventListener("pointerup", handleMobileSheetPointerUp);
      window.addEventListener("pointercancel", handleMobileSheetPointerUp);
      if (mobileMedia.addEventListener) {
        mobileMedia.addEventListener("change", syncMobileModeClasses);
      } else if (mobileMedia.addListener) {
        mobileMedia.addListener(syncMobileModeClasses);
      }
      window.addEventListener("resize", () => syncMobileModeClasses());
      window.addEventListener("orientationchange", () => syncMobileModeClasses());
      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", syncMobileModeClasses);
        window.visualViewport.addEventListener("scroll", syncMobileModeClasses);
      }

      for (const button of $groupChoiceButtons) {
        button.addEventListener("click", () => {
          setSelectValue($group, button.dataset.value);
          syncOptionsMenuState();
          setChoicesOpen("group", false);
        });
      }

      for (const button of $sortChoiceButtons) {
        button.addEventListener("click", () => {
          setSelectValue($sort, button.dataset.value);
          syncOptionsMenuState();
          setChoicesOpen("sort", false);
        });
      }

      function renderListGrouped(items, groupMode, onSelect) {
        $list.innerHTML = "";

        const grouped = new Map();
        for (const f of items) {
          const key = getGroupKey(f, groupMode);
          if (!grouped.has(key)) grouped.set(key, []);
          grouped.get(key).push(f);
        }

        const groupKeys =
          groupMode === "none"
            ? ["All"]
            : Array.from(grouped.keys()).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: "base" }));

        for (const key of groupKeys) {
          const groupItems = grouped.get(key) ?? items;
          if (groupMode !== "none") {
            const header = document.createElement("div");
            header.className = "sectionHeader";
            header.textContent = key;
            $list.appendChild(header);
          } else {
            const spacer = document.createElement("div");
            spacer.className = "sectionHeader sectionHeaderSpacer";
            spacer.textContent = " ";
            spacer.setAttribute("aria-hidden", "true");
            $list.appendChild(spacer);
          }

          const sectionGroup = document.createElement("div");
          sectionGroup.className = "sectionGroup";

          for (const f of groupItems) {
            const row = document.createElement("div");
            row.className = "row";
            row.dataset.id = String(f.id);
            if (selectedFestivalId != null && String(f.id) === String(selectedFestivalId)) {
              row.classList.add("is-selected");
            }

            const rowMain = document.createElement("div");
            rowMain.className = "rowMain";

            const logo = document.createElement("img");
            logo.className = "rowLogo";
            logo.alt = "";
            logo.setAttribute("aria-hidden", "true");
            setImageWithFallback(logo, f.logoAssetUrl);

            const title = document.createElement("p");
            title.className = "rowTitle";
            title.textContent = f.name ?? "Untitled";

            rowMain.append(logo, title);
            row.appendChild(rowMain);

            row.addEventListener("click", () => onSelect(f));
            sectionGroup.appendChild(row);
          }

          $list.appendChild(sectionGroup);

          if (groupMode === "none") break;
        }
      }

      function formatDateRange(f) {
        const opts = { month: "short", day: "numeric", year: "numeric" };
        const start = parseDate(f.dateBegin);
        const end = parseDate(f.dateEnd);
        if (start && end) {
          return `${start.toLocaleDateString(undefined, opts)} - ${end.toLocaleDateString(undefined, opts)}`;
        }
        if (start) return start.toLocaleDateString(undefined, opts);
        if (end) return end.toLocaleDateString(undefined, opts);
        return "Not available";
      }

      function formatTime(value) {
        if (!value) return null;
        const m = /^(\d{1,2}):(\d{2})/.exec(String(value));
        if (!m) return String(value);
        const hours24 = Number(m[1]);
        const minutes = m[2];
        if (!Number.isFinite(hours24)) return String(value);
        const ampm = hours24 >= 12 ? "PM" : "AM";
        const hours12 = ((hours24 + 11) % 12) + 1;
        return `${hours12}:${minutes} ${ampm}`;
      }

      function formatTimeRange(f) {
        const start = formatTime(f.timeBegin);
        const end = formatTime(f.timeEnd);
        if (start && end) return `${start} - ${end}`;
        if (start) return start;
        if (end) return end;
        return "Not available";
      }

      function formatAttendance(value) {
        if (value == null || value === "") return null;
        if (typeof value === "number" && Number.isFinite(value)) {
          return `${value.toLocaleString()}+`;
        }
        return String(value);
      }

      function getEstablishedYear(value) {
        if (typeof value === "number" && Number.isFinite(value)) {
          const year = Math.trunc(value);
          return year >= 1500 && year <= 2100 ? year : null;
        }

        const raw = String(value ?? "").trim();
        if (!raw) return null;
        const match = raw.match(/\b(1[5-9]\d{2}|20\d{2}|2100)\b/);
        if (!match) return null;
        return Number(match[1]);
      }

      function buildDirectionsHref(f) {
        if (f.lat != null && f.lng != null) {
          return `https://maps.apple.com/?ll=${encodeURIComponent(`${f.lat},${f.lng}`)}&q=${encodeURIComponent(f.name ?? "Festival")}`;
        }

        const q = [f.address, f.city, f.state, f.zip].filter(Boolean).join(", ");
        return q ? `https://maps.apple.com/?q=${encodeURIComponent(q)}` : null;
      }

      function setDetailActionLink(el, href, openInNewTab = false) {
        if (!href) {
          el.removeAttribute("href");
          el.removeAttribute("target");
          el.removeAttribute("rel");
          el.setAttribute("aria-disabled", "true");
          el.classList.add("is-disabled");
          return;
        }

        el.href = href;
        el.removeAttribute("aria-disabled");
        el.classList.remove("is-disabled");
        if (openInNewTab) {
          el.target = "_blank";
          el.rel = "noopener noreferrer";
        } else {
          el.removeAttribute("target");
          el.removeAttribute("rel");
        }
      }

      function normalizeSocialUrl(platform, rawValue) {
        const value = String(rawValue ?? "").trim();
        if (!value) return null;
        if (/^https?:\/\//i.test(value)) return value;

        const handle = value.replace(/^@/, "");
        if (!handle) return null;

        if (platform === "facebook") return `https://facebook.com/${handle}`;
        if (platform === "instagram") return `https://instagram.com/${handle}`;
        if (platform === "x") return `https://x.com/${handle}`;
        if (platform === "youtube") {
          if (value.startsWith("@")) return `https://youtube.com/${value}`;
          if (/^(channel\/|c\/|user\/)/i.test(value)) return `https://youtube.com/${value}`;
          return `https://youtube.com/${handle}`;
        }
        return null;
      }

      function getLucideIconMarkup(name) {
        return `<i data-lucide="${name}" aria-hidden="true"></i>`;
      }

      function refreshLucideIcons() {
        if (!window.lucide?.createIcons) return;
        window.lucide.createIcons({
          attrs: { "stroke-width": "2.1" }
        });
      }

      window.addEventListener("load", refreshLucideIcons);

      function getSocialIconSvg(platform) {
        if (platform === "facebook") {
          return getLucideIconMarkup("facebook");
        }
        if (platform === "instagram") {
          return getLucideIconMarkup("instagram");
        }
        if (platform === "youtube") {
          return getLucideIconMarkup("youtube");
        }
        return getLucideIconMarkup("twitter");
      }

      function getSocialEntries(f) {
        const candidates = [
          { platform: "facebook", label: "Facebook", value: f.facebook },
          { platform: "instagram", label: "Instagram", value: f.instagram },
          { platform: "x", label: "X", value: f.x },
          { platform: "youtube", label: "YouTube", value: f.youtube }
        ];

        return candidates
          .map(item => {
            const href = normalizeSocialUrl(item.platform, item.value);
            return href ? { ...item, href } : null;
          })
          .filter(Boolean);
      }

      function getResourceIconSvg(type) {
        if (type === "camp") {
          return getLucideIconMarkup("tent");
        }
        if (type === "tickets") {
          return getLucideIconMarkup("ticket");
        }
        if (type === "lostFound") {
          return getLucideIconMarkup("shield-question-mark");
        }
        return getLucideIconMarkup("map");
      }

      function normalizeResourceHref(rawValue) {
        const value = String(rawValue ?? "").trim();
        if (!value) return null;
        if (/^(https?:|mailto:|tel:)/i.test(value)) return value;
        if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) return `mailto:${value}`;

        const digits = value.replace(/[^\d+]/g, "");
        if (/^\+?\d{7,}$/.test(digits)) return `tel:${digits}`;
        if (/^[^\s]+\.[^\s]+$/.test(value)) return `https://${value}`;
        return null;
      }

      function getResourceEntries(f) {
        return [
          { type: "map", label: "Festival Map", href: f.mapAssetUrl, probeImage: true },
          { type: "camp", label: "Campground Map", href: f.campAssetUrl, probeImage: true },
          { type: "tickets", label: "Tickets", href: normalizeResourceHref(f.tickets), probeImage: false },
          { type: "lostFound", label: "Lost & Found", href: normalizeResourceHref(f.lostAndFound), probeImage: false }
        ].filter(item => !!item.href);
      }

      function checkImageAssetExists(url) {
        if (!url) return Promise.resolve(false);
        if (resourceAssetExistsCache.has(url)) return resourceAssetExistsCache.get(url);

        const probe = new Promise(resolve => {
          const img = new Image();
          img.onload = () => resolve(true);
          img.onerror = () => resolve(false);
          img.src = url;
        });

        resourceAssetExistsCache.set(url, probe);
        return probe;
      }

      async function renderDetailResources(f, renderVersion) {
        const resourceEntries = getResourceEntries(f);
        if (resourceEntries.length === 0) {
          $detailResources.innerHTML = "";
          $detailResourcesCard.hidden = true;
          return;
        }

        const exists = await Promise.all(
          resourceEntries.map(item => (item.probeImage ? checkImageAssetExists(item.href) : Promise.resolve(true)))
        );
        if (renderVersion !== detailRenderVersion) return;

        $detailResources.innerHTML = "";

        for (let i = 0; i < resourceEntries.length; i++) {
          if (!exists[i]) continue;
          const resource = resourceEntries[i];
          const link = document.createElement("a");
          link.className = "detailResourceBtn";
          link.href = resource.href;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.setAttribute("aria-label", resource.label);
          link.innerHTML = `
            <span class="detailResourceIcon">${getResourceIconSvg(resource.type)}</span>
            <span class="detailResourceLabel">${resource.label}</span>
            <span class="detailResourceChevron" aria-hidden="true">${getLucideIconMarkup("chevron-right")}</span>
          `;
          $detailResources.appendChild(link);
        }

        $detailResourcesCard.hidden = $detailResources.childElementCount === 0;
        refreshLucideIcons();
      }

      function updateDetailPanel(f) {
        const renderVersion = ++detailRenderVersion;
        if (!f) {
          $detailResources.innerHTML = "";
          $detailResourcesCard.hidden = true;
          $detailEstablishedValue.textContent = "";
          $detailEstablishedRow.hidden = true;
          $detailSidebar.hidden = true;
          syncMobileDetailSheetState(false);
          return;
        }

        setImageWithFallback($detailHeroLogo, f.logoAssetUrl);
        $detailTitle.textContent = f.name ?? "Untitled";

        if (f.status) {
          $detailStatus.textContent = f.status;
          $detailStatus.hidden = false;
        } else {
          $detailStatus.hidden = true;
        }

        const establishedYear = getEstablishedYear(f.established);
        if (establishedYear) {
          $detailEstablishedValue.textContent = `Est. ${establishedYear}`;
          $detailEstablishedRow.hidden = false;
        } else {
          $detailEstablishedValue.textContent = "";
          $detailEstablishedRow.hidden = true;
        }

        const dateRange = formatDateRange(f);
        $detailDateValue.textContent = dateRange;
        $detailTimeValue.textContent = formatTimeRange(f);
        const attendance = formatAttendance(f.attendance);
        if (attendance) {
          $detailAttendanceValue.textContent = attendance;
          $detailAttendanceRow.hidden = false;
        } else {
          $detailAttendanceValue.textContent = "";
          $detailAttendanceRow.hidden = true;
        }

        const cityState = [f.city, f.state].filter(Boolean).join(", ");
        const line2 = [cityState, f.zip].filter(Boolean).join(" ").trim();
        $detailAddressLine1.textContent = f.address || "Address unavailable";
        $detailAddressLine2.textContent = line2 || "Location unavailable";
        $detailAddressLine3.textContent = "United States";

        const aboutText = f.description?.trim() || "";
        if (aboutText) {
          $detailDesc.textContent = aboutText;
          $detailDescriptionCard.hidden = false;
        } else {
          $detailDesc.textContent = "";
          $detailDescriptionCard.hidden = true;
        }

        const telValue = String(f.phone ?? "").replace(/[^\d+]/g, "");
        const callHref = telValue ? `tel:${telValue}` : null;
        const directionsHref = buildDirectionsHref(f);
        const websiteHref = f.website || null;

        setDetailActionLink($detailActionCall, callHref, false);
        setDetailActionLink($detailActionDirections, directionsHref, true);
        setDetailActionLink($detailAddressOpenBtn, directionsHref, true);
        setDetailActionLink($detailActionWebsite, websiteHref, true);

        const socials = getSocialEntries(f);
        $detailSocials.innerHTML = "";
        if (socials.length > 0) {
          for (const social of socials) {
            const a = document.createElement("a");
            a.className = "detailSocialBtn";
            a.href = social.href;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.setAttribute("aria-label", social.label);
            a.title = social.label;
            a.innerHTML = `
              <span class="detailSocialIcon" aria-hidden="true">${getSocialIconSvg(social.platform)}</span>
            `;
            $detailSocials.appendChild(a);
          }
          $detailSocialCard.hidden = false;
          refreshLucideIcons();
        } else {
          $detailSocialCard.hidden = true;
        }

        $detailResources.innerHTML = "";
        $detailResourcesCard.hidden = true;
        renderDetailResources(f, renderVersion);
        $detailSidebar.hidden = false;
        syncMobileDetailSheetState(true);
      }

      // ---------- Map ----------
      function makeMarker(f) {
        const coord = new mapkit.Coordinate(f.lat, f.lng);
        const crownGlyphImage = {
          1: "/crown.png",
          2: "/crown.png",
          3: "/crown.png"
        };

        const marker = new mapkit.MarkerAnnotation(coord, {
          title: f.name,
          subtitle: f.subtitle,
          glyphImage: crownGlyphImage,
          selectedGlyphImage: crownGlyphImage,
        });

        // clustering
        marker.clusteringIdentifier = "festival";

        marker.data = f;
        return marker;
      }

      function applySystemColorScheme(map) {
        const mql = window.matchMedia?.("(prefers-color-scheme: dark)");
        const set = () => {
          const isDark = !!mql?.matches;

          // MapKit JS supports color schemes; this is the common API shape.
          // If Apple changes names, this will just no-op safely.
          try {
            const cs = mapkit?.Map?.ColorSchemes;
            if (cs) map.colorScheme = isDark ? cs.Dark : cs.Light;
          } catch (_) {}
        };

        set();
        if (mql?.addEventListener) mql.addEventListener("change", set);
        else if (mql?.addListener) mql.addListener(set);
      }

      // ---------- Main ----------
      async function main() {
        refreshLucideIcons();
        await waitForMapKit();

        const map = new mapkit.Map("map", {
          showsCompass: getMapFeatureVisibility("Visible"),
          showsZoomControl: true,
          showsUserLocationControl: getMapFeatureVisibility("Visible")
        });

        applySystemColorScheme(map);

        const allFestivals = await loadFestivals();

        // Create annotations + lookup
        const annotations = allFestivals.map(makeMarker);
        const byId = new Map();
        for (const a of annotations) {
          if (a?.data?.id != null) byId.set(String(a.data.id), a);
        }

        map.addAnnotations(annotations);
        map.showItems(annotations, { animate: false, padding: getMapPadding(60, 60, 60, 60) });

        let selectedAnnotation = null;
        let pendingMapSelectionTimer = null;

        function clearPendingMapSelection() {
          if (!pendingMapSelectionTimer) return;
          clearTimeout(pendingMapSelectionTimer);
          pendingMapSelectionTimer = null;
        }

        function clearFestivalSelection() {
          clearPendingMapSelection();
          selectedFestivalId = null;
          updateDetailPanel(null);
          rerender();

          if (selectedAnnotation) {
            try {
              map.deselectAnnotation(selectedAnnotation);
            } catch (_) {}
          }
          selectedAnnotation = null;
        }

        function selectFestival(f, options = {}) {
          if (!f) return;
          const { zoomToFestival = false, annotation = null } = options;
          const ann = annotation ?? byId.get(String(f.id)) ?? null;
          clearPendingMapSelection();

          selectedFestivalId = f.id;
          updateDetailPanel(f);
          rerender();

          if (!ann) return;

          if (selectedAnnotation && selectedAnnotation !== ann) {
            try {
              map.deselectAnnotation(selectedAnnotation);
            } catch (_) {}
          }

          selectedAnnotation = ann;
          if (zoomToFestival) {
            map.showItems([ann], {
              animate: true,
              padding: getMapPadding(90, 90, 90, 90)
            });
          }

          if (!annotation) {
            const applyMapSelection = () => {
              try {
                map.selectAnnotation(ann);
              } catch (_) {}
            };

            if (zoomToFestival) {
              pendingMapSelectionTimer = setTimeout(() => {
                pendingMapSelectionTimer = null;
                applyMapSelection();
              }, 260);
            } else {
              applyMapSelection();
            }
          }
        }

        $detailCloseBtn.addEventListener("click", clearFestivalSelection);

        // Clicking a cluster zooms in to expand
        map.addEventListener("select", (event) => {
          const a = event.annotation;
          if (!a) return;

          if (Array.isArray(a.memberAnnotations) && a.memberAnnotations.length > 1) {
            map.showItems(a.memberAnnotations, { animate: true, padding: getMapPadding(60, 60, 60, 60) });
            map.deselectAnnotation(a);
            return;
          }

          const festivalId = a?.data?.id;
          if (festivalId == null || !byId.has(String(festivalId))) {
            // Ignore non-festival annotations (for example user location).
            return;
          }

          selectFestival(a.data, { annotation: a });
        });

        function focusFestival(f) {
          selectFestival(f, { zoomToFestival: true });
        }

        function getFilteredAndSorted() {
          const q = normalize($search.value).trim();
          const groupMode = $group.value;
          const sortMode = $sort.value;

          const filtered = !q
            ? allFestivals
            : allFestivals.filter(f => {
                const hay = `${f.name ?? ""} ${f.city ?? ""} ${f.state ?? ""} ${f.stateName ?? ""} ${f.status ?? ""}`.toLowerCase();
                return hay.includes(q);
              });

          const sorted = sortFestivals(filtered, sortMode);

          return { items: sorted, groupMode };
        }

        function rerender() {
          const { items, groupMode } = getFilteredAndSorted();
          renderListGrouped(items, groupMode, focusFestival);
        }

        // Initial render
        rerender();
        syncOptionsMenuState();
        updateSearchClearVisibility();
        updateDetailPanel(null);
        syncMobileModeClasses();

        // Controls
        $search.addEventListener("input", () => {
          updateSearchClearVisibility();
          rerender();
        });
        $group.addEventListener("change", () => {
          syncOptionsMenuState();
          rerender();
        });
        $sort.addEventListener("change", () => {
          syncOptionsMenuState();
          rerender();
        });
      }

      main().catch(err => {
        console.error(err);
        document.body.innerHTML =
          `<pre style="padding:16px;white-space:pre-wrap">Error:\n${err?.message || err}</pre>`;
      });
    </script>
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"11660f41b0ec4495bfda86fd385e9f15","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
